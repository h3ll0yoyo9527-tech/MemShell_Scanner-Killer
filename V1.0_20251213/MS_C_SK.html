<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SpringBoot—Controller MemoryShell Scanner/Killer</title>
</head>
<body>
<center>
    <div>
        <h2>SpringBoot—Controller MemoryShell Scanner/Killer</h2>

        <div id="message"></div>

        <div>
            <h4 style="display: inline-block; margin-right: 10px;">Scan Result</h4>
            <label style="display: inline-block;">
                <input type="checkbox" id="compactMode" onchange="refreshDisplay()">
                精简模式
            </label>
        </div>

        <table border="1" cellspacing="0" width="95%" style="table-layout:fixed;word-break:break-all;background:#f2f2f2">
            <thead>
            <tr>
                <th width="4%">ID</th>
                <th width="8%">URL模式</th>
                <th width="18%">Controller类名</th>
                <th width="8%">方法名</th>
                <th width="5%">请求方法</th>
                <th width="15%">类加载器</th>
                <th width="18%">文件路径</th>
                <th width="15%">控制器类型</th>
                <th width="4%">删除</th>
                <th width="5%">Dump</th>
            </tr>
            </thead>
            <tbody id="resultBody">
            </tbody>
        </table>

        <br/>
        <div>ddg：甲方现场不相信眼泪</div>
    </div>
</center>

<script>
    // 全局变量存储扫描结果
    let allControllers = [];

    // 页面加载时自动扫描
    document.addEventListener('DOMContentLoaded', function() {
        refreshScan();
    });

    function refreshScan() {
        fetch('/C/scan')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allControllers = data.controllers;
                    refreshDisplay();
                    showMessage(`扫描完成，共发现 ${allControllers.length} 个Controller方法`, 'success');
                } else {
                    showMessage('扫描失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('扫描失败: ' + error, 'error');
            });
    }

    function refreshDisplay() {
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';

        const compactMode = document.getElementById('compactMode').checked;

        // 根据精简模式过滤控制器
        const displayControllers = compactMode ? allControllers.filter(controller => controller.removable) : allControllers;

        if (displayControllers.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="10" style="text-align:center;color:gray;">${compactMode ? '没有可删除的控制器方法' : '没有找到控制器方法'}</td>`;
            tbody.appendChild(row);
            return;
        }

        displayControllers.forEach((controller, index) => {
            const row = document.createElement('tr');

            // 转义HTML特殊字符
            const escapeHtml = (text) => {
                if (text === null || text === undefined) return '';
                return String(text).replace(/[&<>"']/g, function(match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            };

            const urlPatterns = Array.isArray(controller.urlPatterns) ?
                controller.urlPatterns.map(escapeHtml).join('<br>') :
                escapeHtml(controller.urlPatterns);

            const className = escapeHtml(controller.className);
            const methodName = escapeHtml(controller.methodName);
            const httpMethods = Array.isArray(controller.httpMethods) ?
                controller.httpMethods.map(escapeHtml).join(', ') :
                escapeHtml(controller.httpMethods);
            const classLoader = escapeHtml(controller.classLoader);
            const classLocation = escapeHtml(controller.classLocation);
            const handlerType = escapeHtml(controller.handlerType);

            // 获取第一个URL模式（用于删除）
            const firstUrlPattern = Array.isArray(controller.urlPatterns) && controller.urlPatterns.length > 0 ?
                controller.urlPatterns[0] : '';

            row.innerHTML = `
                <td style="text-align:center">${index + 1}</td>
                <td>${urlPatterns}</td>
                <td>${className}</td>
                <td>${methodName}</td>
                <td>${httpMethods}</td>
                <td>${classLoader}</td>
                <td>${classLocation}</td>
                <td>${handlerType}</td>
                <td style="text-align:center">
                    ${controller.removable ?
                `<a href="javascript:void(0)"
                    onclick="killController('${className}', '${methodName}', '${escapeForJs(firstUrlPattern)}', '${escapeForJs(handlerType)}')"
                    style="color:red;font-weight:bold">删除</a>` :
                '<span style="color:gray">禁止删除</span>'
            }
                </td>
                <td style="text-align:center">
                    <a href="javascript:void(0)" onclick="dumpClass('${className}')">Dump</a>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // 用于JavaScript字符串转义
    function escapeForJs(str) {
        return str.replace(/\\/g, '\\\\')
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\r');
    }

    function killController(className, methodName, urlPattern, handlerType) {
        const confirmMessage = handlerType.includes('注解方式') ?
            `确定要删除 ${className}.${methodName}() 方法吗？` :
            `确定要删除 ${className} 的 URL: ${urlPattern} 吗？`;

        if (confirm(confirmMessage)) {
            const formData = new URLSearchParams();
            formData.append('className', className);
            formData.append('methodName', methodName);
            formData.append('urlPattern', urlPattern);
            formData.append('handlerType', handlerType);

            fetch('/C/kill', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('删除成功: ' + data.message, 'success');
                        refreshScan();
                    } else {
                        showMessage('删除失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('删除失败: ' + error, 'error');
                });
        }
    }

    function dumpClass(className) {
        window.open(`/C/dump?className=${encodeURIComponent(className)}`, '_blank');
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        const color = type === 'error' ? 'red' : 'green';
        messageDiv.innerHTML = `<p style='color:${color}'>${message}</p>`;

        // 3秒后自动消失
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 3000);
    }
</script>
</body>
</html>